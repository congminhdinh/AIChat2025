version: '3.8'

services:
  # ============================================
  # Infrastructure Services
  # ============================================

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong!Passw0rd
    networks:
      - aichat-network
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - aichat-network
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
    volumes:
      - G:/Mount/qdrant:/qdrant/storage
    networks:
      - aichat-network
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - G:/Mount/ollama:/root/.ollama
    networks:
      - aichat-network
    restart: always

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
    command: server /data --console-address ":9001"
    volumes:
      - G:/Mount/minio:/data
    networks:
      - aichat-network
    restart: unless-stopped

  # ============================================
  # .NET Microservices
  # ============================================

  accountservice:
    build:
      context: .
      dockerfile: Services/AccountService/Dockerfile
    container_name: accountservice
    ports:
      - "5051:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ConnectionStrings__AccountDbContext=Server=sqlserver;Database=AIChat2025;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;MultipleActiveResultSets=true
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - aichat-network
    restart: unless-stopped

  tenantservice:
    build:
      context: .
      dockerfile: Services/TenantService/Dockerfile
    container_name: tenantservice
    ports:
      - "5062:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ConnectionStrings__TenantDbContext=Server=sqlserver;Database=AIChat2025;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;MultipleActiveResultSets=true
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - aichat-network
    restart: unless-stopped

  documentservice:
    build:
      context: .
      dockerfile: Services/DocumentService/Dockerfile
    container_name: documentservice
    ports:
      - "5165:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ConnectionStrings__DocumentDbContext=Server=sqlserver;Database=AIChat2025;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;MultipleActiveResultSets=true
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - aichat-network
    restart: unless-stopped

  storageservice:
    build:
      context: .
      dockerfile: Services/StorageService/Dockerfile
    container_name: storageservice
    ports:
      - "5113:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - MinioEndpoint=minio:9000
      - MinioAccessKey=admin
      - MinioSecretKey=password
      - MinioBucket=ai-chat-2025
      - DocumentFilePath=/app/storages
    volumes:
      - storageservice-data:/app/storages
    depends_on:
      - sqlserver
      - rabbitmq
      - minio
    networks:
      - aichat-network
    restart: unless-stopped

  chatservice:
    build:
      context: .
      dockerfile: Services/ChatService/Dockerfile
    container_name: chatservice
    ports:
      - "5218:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ConnectionStrings__ChatDbContext=Server=sqlserver;Database=AIChat2025;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;MultipleActiveResultSets=true
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - aichat-network
    restart: unless-stopped


  apigateway:
    build:
      context: .
      dockerfile: ApiGateway/Dockerfile
    container_name: apigateway
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
    depends_on:
      - accountservice
      - tenantservice
      - documentservice
      - storageservice
      - chatservice
    networks:
      - aichat-network
    restart: unless-stopped

  embeddingservice:
    build:
      context: .
      dockerfile: Services/EmbeddingService/Dockerfile
    container_name: embeddingservice
    ports:
      - "8000:8000"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      - qdrant
    networks:
      - aichat-network
    restart: unless-stopped

  chatprocessor:
    build:
      context: .
      dockerfile: Services/ChatProcessor/Dockerfile
    container_name: chatprocessor
    ports:
      - "8001:8001"
    environment:
      - RABBITMQ_HOST=rabbitmq
      - QDRANT_HOST=qdrant
      - OLLAMA_BASE_URL=http://ollama:11434
    depends_on:
      - rabbitmq
      - qdrant
      - ollama
    networks:
      - aichat-network
    restart: unless-stopped

networks:
  aichat-network:
    driver: bridge

volumes:
  storageservice-data:
