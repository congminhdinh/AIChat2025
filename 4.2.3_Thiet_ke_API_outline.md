# 4.2.3 Thiết kế API (API Design)

## Giới thiệu

Phần này trình bày thiết kế các API RESTful và SignalR của hệ thống Multi-tenant RAG. Hệ thống được chia thành nhiều microservice độc lập, mỗi service cung cấp một tập API phục vụ chức năng riêng biệt. Tất cả các API tuân thủ các nguyên tắc thiết kế sau:

- **Response Wrapper**: Mọi API đều trả về `BaseResponse<T>` chứa trạng thái, thông báo và dữ liệu
- **Request Inheritance**: Các request model kế thừa từ `BaseRequest` để đảm bảo metadata nhất quán
- **Pagination**: Sử dụng `PaginatedRequest` cho các endpoint danh sách
- **Multi-tenant Isolation**: TenantId được truyền qua JWT token và áp dụng tự động

---

## 4.2.3.1 Tổng quan API theo Service

### A. AccountService (11 endpoints)
Quản lý tài khoản người dùng, xác thực và phân quyền.

| Nhóm chức năng | Số lượng API |
|----------------|--------------|
| Authentication | 2 |
| Account CRUD | 7 |
| Tenant Management | 2 |

### B. TenantService (6 endpoints)
Quản lý thông tin doanh nghiệp (tenant) trong hệ thống multi-tenant.

| Nhóm chức năng | Số lượng API |
|----------------|--------------|
| Health Check | 1 |
| Tenant CRUD | 5 |

### C. ChatService (26 endpoints)
Xử lý hội thoại, tin nhắn và cấu hình prompt cho chatbot RAG.

| Nhóm chức năng | Số lượng API |
|----------------|--------------|
| Conversation Management | 3 |
| Message Operations | 2 |
| Chat Feedback | 5 |
| System Prompt | 5 |
| Prompt Config | 5 |
| SignalR Hub Methods | 6 |

### D. DocumentService (8 endpoints)
Quản lý tài liệu, tải lên và vector hóa cho tìm kiếm ngữ nghĩa.

| Nhóm chức năng | Số lượng API |
|----------------|--------------|
| Health Check | 1 |
| Document CRUD | 5 |
| Vectorization | 2 |

### E. StorageService (4 endpoints)
Lưu trữ file trên hệ thống local và MinIO object storage.

| Nhóm chức năng | Số lượng API |
|----------------|--------------|
| Local Storage | 2 |
| MinIO Storage | 2 |

### F. ChatProcessor - Python (4 endpoints)
Service Python xử lý RAG pipeline và sinh câu trả lời từ LLM.

| Nhóm chức năng | Số lượng API |
|----------------|--------------|
| Health Check | 1 |
| Chat Processing | 2 |
| Batch Evaluation | 1 |

### G. EmbeddingService - Python (6 endpoints)
Service Python sinh embedding vector và quản lý Qdrant vector database.

| Nhóm chức năng | Số lượng API |
|----------------|--------------|
| Health Check | 1 |
| Embedding Generation | 1 |
| Vector Storage | 3 |
| Similarity Search | 1 |

---

## 4.2.3.2 Thống kê tổng hợp

| Loại | Số lượng |
|------|----------|
| **Tổng số API** | **65** |
| REST API (.NET) | 49 |
| SignalR Hub Methods | 6 |
| REST API (Python) | 10 |

| Service | Platform | Endpoints |
|---------|----------|-----------|
| AccountService | .NET 8 | 11 |
| TenantService | .NET 8 | 6 |
| ChatService | .NET 8 + SignalR | 26 |
| DocumentService | .NET 8 | 8 |
| StorageService | .NET 8 | 4 |
| ChatProcessor | Python FastAPI | 4 |
| EmbeddingService | Python FastAPI | 6 |

---

## 4.2.3.3 Chi tiết API

Chi tiết đầy đủ của từng API bao gồm: HTTP Method, Route, Input Parameters, Output Type và Description được trình bày trong bảng đính kèm (file Excel).

---

## 4.2.3.4 Quy ước Response Format

### .NET Services (BaseResponse)

```json
{
  "success": true,
  "message": "Operation completed successfully",
  "data": { ... }
}
```

### Python Services

```json
{
  "status": "success",
  "data": { ... }
}
```

### Paginated Response

```json
{
  "success": true,
  "data": {
    "items": [...],
    "pageIndex": 1,
    "pageSize": 10,
    "totalCount": 100,
    "totalPages": 10
  }
}
```

---

## 4.2.3.5 Quy ước Error Response

```json
{
  "success": false,
  "message": "Error description",
  "errors": [
    {
      "field": "email",
      "message": "Email is required"
    }
  ]
}
```

HTTP Status Codes:
- `200 OK`: Thành công
- `201 Created`: Tạo mới thành công
- `400 Bad Request`: Dữ liệu đầu vào không hợp lệ
- `401 Unauthorized`: Chưa xác thực
- `403 Forbidden`: Không có quyền truy cập
- `404 Not Found`: Không tìm thấy resource
- `500 Internal Server Error`: Lỗi server

---

*Xem chi tiết đầy đủ các API trong file đính kèm: `4.2.3_API_Documentation.xlsx`*
