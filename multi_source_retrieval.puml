@startuml
title **Cơ chế truy xuất đa nguồn và sinh phản hồi tùy biến**

skinparam backgroundColor #FFFFFF
skinparam ActivityBackgroundColor #FFFDE7
skinparam ActivityBorderColor #666666
skinparam ActivityDiamondBackgroundColor #FFF9C4
skinparam ActivityDiamondBorderColor #666666
skinparam ArrowColor #333333
skinparam NoteBorderColor #A5D6A7
skinparam NoteBackgroundColor #E8F5E9

start

:Nhận câu hỏi người dùng;

:Mở rộng truy vấn
(Query Expansion);
note right #E8F5E9
  "OT" → "Overtime"
  "NLĐ" → "Người lao động"
end note

:Tạo Vector Embedding;

fork
  :Tìm trong
  **Nội quy Công ty**
  (tenant_id = X);

  :Vector Search
  (Semantic Similarity);

  :Top K kết quả Tenant
  (xếp hạng theo cosine);

fork again
  :Tìm trong
  **Văn bản Pháp luật**
  (tenant_id = 1);

  :Vector Search
  (Semantic Similarity);

  :Top K kết quả Global
  (xếp hạng theo cosine);

end fork

:Hợp nhất kết quả
(RRF - Reciprocal Rank Fusion);
note right #E8F5E9
  Score = 1/(k + rank_tenant)
        + 1/(k + rank_global)
  Với k = 60

  **Ưu điểm:**
  Đảm bảo có kết quả
  từ CẢ HAI nguồn
end note

:Đánh giá chất lượng
kết quả Tenant;

if (Kết quả Tenant đủ chất lượng?\n(≥2 kết quả trong Top 3 RRF)) then (Có)
  :Chế độ Bình thường
  **60% Tenant + 40% Global**
  (~3 Tenant + ~2 Global);
else (Không)
  :Chế độ Dự phòng
  **Ưu tiên Pháp luật**
  (1-2 Tenant + 3-4 Global);
endif

:Kết quả cuối cùng
**Top 5**;

if (Có cả Nội quy\nvà Pháp luật?) then (BOTH)
  :Prompt **SO SÁNH**
  (So sánh 2 nguồn);
elseif (Chỉ có Nội quy?) then (COMPANY)
  :Prompt **Nguồn đơn**
  (Chỉ Nội quy);
elseif (Chỉ có Pháp luật?) then (LEGAL)
  :Prompt **Nguồn đơn**
  (Chỉ Pháp luật);
elseif (Có SystemPrompt?) then (STATIC)
  :Prompt **Ngữ cảnh tĩnh**
  (Không có RAG);
else (NONE)
  :Trả về thông báo lỗi;
  stop
endif

:Cấu trúc Ngữ cảnh Phân cấp;
note right #FFECB3
  **Ưu tiên 1:** Nội quy Công ty
  **Ưu tiên 2:** Văn bản Pháp luật
end note

:Sinh câu trả lời từ LLM
(Vistral - temperature=0.1);

:Gửi kết quả về người dùng
(+ reference_doc_id_list);

stop

@enduml
