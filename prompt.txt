Role: Expert Python Backend Developer / Distributed Systems Architect

Task: Update RabbitMQ message processing and event schemas for ChatProcessor and EmbeddingService.

1. Objective Update the Python backend services to support the latest .NET event structures. Focus on mapping IDs through the processing pipeline and extracting RAG metadata from the vector database.

2. Event Schemas (C# Reference)

Received Event: UserPromptReceivedEvent

Fields: ConversationId, MessageId (New), Message, Token, Timestamp, SystemInstruction, SystemPrompt.

Return Event: BotResponseCreatedEvent

Fields: ConversationId, RequestId (New - maps to MessageId), ReferenceDocIdList (New), Message, Token, Timestamp, ModelUsed.

3. Logic Requirements

ID Persistence: Extract MessageId from the incoming UserPromptReceivedEvent. This ID must be carried through the entire processing flow and returned as the RequestId in the final BotResponseCreatedEvent.

RAG ID Extraction: Within the retrieval logic (connecting to Qdrant), capture the unique source_id from the payload of every retrieved document chunk.

Event Construction: Aggregate these source_id values into the ReferenceDocIdList.

Naming Conventions: Implement a mapping strategy to bridge PascalCase (used by .NET RabbitMQ events) and snake_case (used within Python logic). Ensure the final JSON payload sent back to RabbitMQ matches the .NET record property names exactly.

4. Implementation Scope

ChatProcessor: Update the consumer logic to parse the new MessageId and ensure it is passed to the internal processing functions.

EmbeddingService / ChatBusiness: Modify the search/retrieval functions to return both the content and the list of unique source_id values.

RabbitMQ Producer: Ensure the outgoing message strictly adheres to the BotResponseCreatedEvent structure, specifically:

RequestId = original MessageId.

ReferenceDocIdList = List of unique integers/IDs from Qdrant search results.

5. Technical Constraints

Use Pydantic models with alias or Field configuration if available to manage case conversion.

Maintain strictly identical field names for the outgoing RabbitMQ JSON to prevent .NET deserialization errors.